{"version":3,"sources":["meteor://ðŸ’»app/packages/wildarch:exact-api/exact-api.js"],"names":["rest","Npm","require","xml2js","clone","cookie_parser","local_conf","client_id","secret","redirect_url","conf","process","env","ROOT_URL","exact_base_url","exact_auth_url","exact_token_url","exact_get_url","exact_post_url","exactapi","getAuthURL","isAuthorized","exact","undefined","getShopOrders","options","result","Meteor","wrapAsync","getShopOrder","orderNumber","getSalesOrder","orderID","getSalesOrders","getItem","itemID","getItems","groupID","parseJSONDate","jsonDate","Date","parseInt","substr","tokenRefresh","getDivisions","setDivision","div","division","getDivision","getSalesOrderLines","getItemGroups","getBOM","sourceID","copyBOM","destItems","cookies","id","delete","getShopOrderMaterialPlans","getShopOrderChildren","getProject","projectCode","access_token","refresh_token","cb","post","data","grant_type","client_secret","on","response","console","log","expires_in","WebApp","connectHandlers","use","req","res","next","Exact","query","code","writeHead","end","service","auth_code","self","redirect_uri","getCurrentDivision","baseURL","filter","min_date","project","get","$filter","$select","$expand","headers","parser","parsers","json","d","results","length","startDate","toISOString","err","$orderby","warn","JSON","stringify","ShopOrderMaterialPlans","__next","forEach","elem","push","left","groups","ID","description","Description","source_id","dest_items","builder","BOMBuilder","cookie_holder","CookieHolder","updates","cb_called","i","iterator","item","getBOMID","ok","update_cookies","key","message","set_item","xml","get_xml","postBOM","statusCode","msg","eExact","Messages","Message","Topic","Data","$","keyAlt","setTimeout","source_ID","Params_Item","_Division_","ManufacturedBillofMaterials","ManufacturedBillofMaterial","item_ID","BCAction","CSRFToken","get_csrf","Cookie","get_cookies","timeout","error","cookieFormat","hasOwnProperty","parse","ack","cookie","name","value","boms","base_bom","Builder","props","Item","buildObject","add","bom","add_copy","new_bom"],"mappings":"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","file":"/packages/wildarch_exact-api.js","sourcesContent":["// Write your package code here!\nvar rest = Npm.require('restler');\nvar xml2js = Npm.require('xml2js');\nvar clone = Npm.require('clone');\nvar cookie_parser = Npm.require('set-cookie-parser');\n\nvar local_conf = {\n    client_id: \"28554901-0075-4e86-92f4-76764817b4f3\",\n    secret: \"CsiVKM9ou5Fy\",\n    redirect_url: \"https://localhost/exactauth\"\n};\nvar conf = {\n    client_id: \"2c023656-d37a-451b-a2ee-df72bab08f59\",\n    secret: \"pWm2S2zwDNqh\",\n    redirect_url: \"https://blueboard-wildarch.rhcloud.com/exactauth\"\n};\n\nif(process.env.ROOT_URL == \"http://localhost:3000/\") {\n    conf = local_conf;\n}\n\nvar exact_base_url = \"https://start.exactonline.nl\";\nvar exact_auth_url = exact_base_url+\"/api/oauth2/auth?response_type=code&client_id=\" + conf.client_id + \"&redirect_uri=\"+ conf.redirect_url + \"&force_login=0\";\nvar exact_token_url = exact_base_url+\"/api/oauth2/token\";\nvar exact_get_url = \"/docs/XMLDownload.aspx\";\nvar exact_post_url = \"/docs/XMLUpload.aspx\";\n\nexactapi = {\n    getAuthURL: function(){\n        return exact_auth_url;\n    },\n    isAuthorized: function(){\n        return exact != undefined;\n    },\n    getShopOrders: function(options){\n        var result = Meteor.wrapAsync(exact.getShopOrders)(options);\n        return result;\n    },\n    getShopOrder: function (orderNumber) {\n        return Meteor.wrapAsync(exact.getShopOrder)(orderNumber);\n    },\n    getSalesOrder: function(orderID){\n        return Meteor.wrapAsync(exact.getSalesOrder)(orderID);\n    },\n    getSalesOrders: function(options){\n        return Meteor.wrapAsync(exact.getSalesOrders)(options);\n    },\n    getItem: function(itemID){\n        return Meteor.wrapAsync(exact.getItem)(itemID);\n    },\n    getItems: function(groupID){\n        return Meteor.wrapAsync(exact.getItems)(groupID);\n    },\n    parseJSONDate: function(jsonDate){\n        if(!jsonDate) return;\n        return new Date(parseInt(jsonDate.substr(6)));\n    },\n    tokenRefresh: function(){\n        if(exact == undefined) return;\n        return Meteor.wrapAsync(tokenRefresh)();\n    },\n    getDivisions: function(){\n        if(exact == undefined) return;\n        return Meteor.wrapAsync(exact.getDivisions)();\n    },\n    setDivision: function(div){\n        if(exact == undefined) return;\n        division = div;\n    },\n    getDivision: function(){\n        if(exact == undefined) return;\n        return division;\n    },\n    getSalesOrderLines: function(itemID){\n        return Meteor.wrapAsync(exact.getSalesOrderLines)(itemID);\n    },\n    getItemGroups: function(){\n        return Meteor.wrapAsync(exact.getItemGroups)();\n    },\n    getBOM: function(sourceID){\n        return Meteor.wrapAsync(exact.getBOM)(sourceID);\n    },\n    copyBOM: function(sourceID, destItems, cookies){\n        return Meteor.wrapAsync(exact.copyBOM)(sourceID, destItems, cookies);\n    },\n    delete: function(id){\n        return Meteor.wrapAsync(exact.delete)(id);\n    },\n    getShopOrderMaterialPlans: function(orderID){\n        return Meteor.wrapAsync(exact.getShopOrderMaterialPlans)(orderID);\n    },\n    getShopOrderChildren: function (orderID) {\n        return Meteor.wrapAsync(exact.getShopOrderChildren)(orderID);\n    },\n    getProject: function (projectCode) {\n        return Meteor.wrapAsync(exact.getProject)(projectCode);\n    }\n};\n\nvar exact;\nvar access_token;\nvar refresh_token;\n\nvar tokenRefresh = function(cb) {\n    rest.post(exact_token_url, {\n        data: {\n            refresh_token: refresh_token,\n            grant_type: \"refresh_token\",\n            client_id: conf.client_id,\n            client_secret: conf.secret\n        },\n    }).on('complete', function (data, response) {\n        if(!data.access_token){\n            console.log(\"Error refreshing token!\");\n            exact = undefined;\n        }\n        access_token = data.access_token;\n        refresh_token = data.refresh_token;\n        console.log(\"Token refreshed, next in refresh after: \" + data.expires_in);\n        cb(null, data.refresh_token);\n    });\n}\n\nWebApp.connectHandlers.use('/exactauth', function(req, res, next) {\n    exact = new Exact(req.query.code, function(){\n        // 301 Send to main app\n        res.writeHead(301, {\n            'Location': '/'\n        });\n        res.end();\n    });\n});\nvar division;\nvar Exact = rest.service(function(auth_code, cb){\n    var self = this;\n    rest.post(exact_token_url,\n        {\n            data: {\n                code: auth_code,\n                redirect_uri: conf.redirect_url,\n                grant_type:\t\"authorization_code\",\n                client_id: conf.client_id,\n                client_secret: conf.secret\n            }\n\n        }).on('complete', function(data, response){\n            access_token = data.access_token;\n            console.log(data);\n            console.log(\"Access token: \" + access_token);\n            refresh_token = data.refresh_token;\n            console.log(\"Refresh token: \" + refresh_token);\n            self.getCurrentDivision(function(div){\n                division = div;\n                console.log(\"Division: \"+div);\n            });\n            cb();\n        });\n},\n{ baseURL: exact_base_url },\n{\n    getShopOrders: function(options, cb){\n        var filter = \"\";\n        if(options.min_date){\n            filter = \"PlannedDate ge DateTime'\"+options.min_date+\"'\";\n        }\n        else if(options.project){\n            filter = \"Project eq guid'\"+options.project+\"'\";\n        }\n        \n        exact.get('/api/v1/'+division+'/manufacturing/ShopOrders',{\n            query: {\n                access_token: access_token,\n                $filter: filter,\n                $select: \"ID, ShopOrderNumber, ShopOrderMaterialPlans, ShopOrderRoutingStepPlans, ShopOrderParentNumber, SalesOrderLines, PlannedDate, PlannedQuantity, Description, Notes, Item\",\n                $expand: \"SalesOrderLines, ShopOrderMaterialPlans, ShopOrderRoutingStepPlans\"\n            },\n            headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n            parser: rest.parsers.json\n        }).on('complete', function(data, response){\n            if(data.d && data.d.results && data.d.results.length > 0){\n                cb(null, data.d.results);\n            }\n            else {\n                cb(\"Could not retrieve shop orders\", data);\n            }\n        });\n    },\n    getProject: function (options, cb) {\n        var filter = \"\";\n        if(options.projectCode){\n            filter = \"Code eq '\"+options.projectCode+\"'\";\n        }\n        else if(options.startDate){\n            filter = \"StartDate gt DateTime'\"+options.startDate.toISOString()+\"'\";\n        }\n        else {\n            console.err(\"Invalid options for project\");\n        }\n        exact.get('/api/v1/'+division+'/project/Projects',{\n            query: {\n                access_token: access_token,\n                $filter: filter,\n                $orderby: \"StartDate desc\",\n                $select: \"ID, Description, Code, CreatorFullName, StartDate, EndDate\"\n            },\n            headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n            parser: rest.parsers.json\n        }).on('complete', function (data, response) {\n            if(data.d && data.d.results && data.d.results.length > 0){\n                if(options.projectCode) cb(null, data.d.results[0]);\n                else cb(null, data.d.results);\n            }\n            else {\n                console.warn(\"Could not retrieve project\");\n                console.log(JSON.stringify(data));\n                cb(\"Could not retrieve project\", data);\n            }\n        })\n    },\n\n    getShopOrder: function(orderNumber, cb){\n        exact.get('/api/v1/'+division+'/manufacturing/ShopOrders',{\n            query: {\n                access_token: access_token,\n                $filter: \"ShopOrderNumber eq \"+orderNumber,\n                $select: \"ID, ShopOrderNumber, ShopOrderMaterialPlans, ShopOrderRoutingStepPlans, ShopOrderParentNumber, SalesOrderLines, PlannedDate, PlannedQuantity, Description, Notes, Item\",\n                $expand: \"SalesOrderLines, ShopOrderMaterialPlans, ShopOrderRoutingStepPlans\"\n            },\n            headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n            parser: rest.parsers.json\n        }).on('complete', function(data, response){\n            var res = data.d.results[0];\n            if(!res){\n                cb(JSON.stringify(data), null);\n            }\n            else if(res.ShopOrderMaterialPlans && res.ShopOrderMaterialPlans.__next){\n                console.log(\"Issuing extra request: \"+res.ShopOrderMaterialPlans.__next+'&access_token='+access_token);\n                rest.get(res.ShopOrderMaterialPlans.__next+'&access_token='+access_token, {\n                    headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n                    //parser: rest.parsers.json\n                }).on('complete', function(data, response){\n                    if(data && data.d.results){\n                        console.log(\"Appending extra elements: \"+data.d.results.length);\n                        data.d.results.forEach(function(elem){\n                            res.ShopOrderMaterialPlans.results.push(elem);\n                        });\n                    }\n                    cb(null, res);\n                });\n            }\n            else {\n                cb(null, res);\n            }\n        });\n    },\n    getShopOrderChildren: function(orderID, cb){\n        exact.get('/api/v1/'+division+'/manufacturing/ShopOrders',{\n            query: {\n                access_token: access_token,\n                $filter: \"ShopOrderParent eq guid'\"+orderID+\"'\",\n                $select: \"ID, ShopOrderNumber, ShopOrderMaterialPlans, ShopOrderRoutingStepPlans, SalesOrderLines, PlannedDate, PlannedQuantity, Description, Notes, Item\",\n                $expand: \"SalesOrderLines, ShopOrderMaterialPlans, ShopOrderRoutingStepPlans\"\n            },\n            headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n            parser: rest.parsers.json\n        }).on('complete', function(data, response){\n            if(!data.d.results){\n                cb(JSON.stringify(data), null);\n                return;\n            }\n\n            var left = data.d.results.length;\n            if(left == 0) return cb(null, data.d.results);\n\n            data.d.results.forEach(function (res) {\n                if(res.ShopOrderMaterialPlans && res.ShopOrderMaterialPlans.__next){\n                    console.log(\"Issuing extra request: \"+res.ShopOrderMaterialPlans.__next+'&access_token='+access_token);\n                    rest.get(res.ShopOrderMaterialPlans.__next+'&access_token='+access_token, {\n                        headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n                        //parser: rest.parsers.json\n                    }).on('complete', function(data, response){\n                        if(data && data.d.results){\n                            console.log(\"Appending extra elements: \"+data.d.results.length);\n                            data.d.results.forEach(function(elem){\n                                res.ShopOrderMaterialPlans.results.push(elem);\n                            });\n                        }\n                        left--;\n                        if(left == 0) return cb(null, data.d.results);\n                    });\n                }\n                else {\n                    left--;\n                    if(left == 0) return cb(null, data.d.results);\n                }\n            });\n        });\n    },\n    getShopOrderMaterialPlans: function(orderID, cb){\n        exact.get('/api/v1/'+division+'/manufacturing/ShopOrderMaterialPlans', {\n            query: {\n                access_token: access_token,\n                $filter: \"ShopOrder eq \"+orderID,\n                $select: \"Description, ItemDescription, ItemCode, LineNumber, PlannedQuantity, Unit, UnitDescription, Notes\",\n            },\n            headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n            parser: rest.parsers.json\n        }).on('complete', function(data, response){\n            var res = data.d.results;\n            if(res){\n                cb(null, res);\n            }\n            else {\n                cb(JSON.stringify(data), null);\n            }\n        });\n    },\n    getCurrentDivision: function(cb){\n        this.get('/api/v1/current/Me', {\n            query: {\n                access_token: access_token,\n                $select: \"CurrentDivision\"\n            },\n            headers: { 'Accept': 'application/json'},\n            parser: rest.parsers.json\n        }).on('complete', function(data, response){\n            cb(data.d.results[0][\"CurrentDivision\"]);\n        });\n    },\n    getDivisions: function(cb){\n        exact.get('/api/v1/'+division+'/system/Divisions', {\n            query: {\n                access_token: access_token,\n                $select: \"Code,Description\"\n            },\n            headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n        }).on('complete', function(data, response){\n            if(!data.d || !data.d.results){\n                console.log(\"Some error occurred! \"+data);\n                return cb(data, null);\n            }\n            cb(null, data.d.results);\n        })\n    },\n    getSalesOrder: function(orderID, cb){\n        exact.get('/api/v1/'+division+'/salesorder/SalesOrders', {\n            query: {\n                access_token: access_token,\n                $filter: \"OrderID eq guid'\"+orderID+\"'\",\n                $select: \"DeliverToName, OrderNumber\",\n            },\n            headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n        }).on('complete', function(data, response){\n           if(data.d && data.d.results){\n               cb(null, data.d.results[0]);\n           }\n           else {\n               cb(\"Error retrieving sales order\", data);\n           }\n        });\n    },\n    getSalesOrderLines: function(orderID, cb){\n        exact.get('/api/v1/'+division+'/salesorder/SalesOrderLines', {\n            query: {\n                access_token: access_token,\n                $filter: \"OrderID eq guid'\"+orderID+\"'\",\n                $select: \"DeliveryDate, Description, NetPrice, Notes, Discount, LineNumber\"\n            },\n            headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n        }).on('complete', function(data, response){\n            if(data.d && data.d.results){\n                cb(null, data.d.results);\n            }\n            else {\n                cb(\"Error retrieving sales order lines\", data);\n            }\n        });\n    },\n    getSalesOrders: function(options, cb){\n        exact.get('/api/v1/'+division+'/salesorder/SalesOrders', {\n            query: {\n                access_token: access_token,\n                $filter: \"OrderDate ge DateTime'\"+options.min_date+\"'\",\n                $select: \"DeliverToName\",\n            },\n            headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n        }).on('complete', function(data, response){\n            if(data.d && data.d.results){\n                cb(null, data.d.results);\n            }\n            else {\n                cb(\"Error retrieving sales orders\", data);\n            }\n        });\n    },\n    getItem: function(itemID, cb){\n        exact.get('/api/v1/'+division+'/logistics/Items', {\n            query: {\n                access_token: access_token,\n                $filter: \"ID eq guid'\"+itemID+\"'\",\n                $select: \"ItemGroupDescription, Code\",\n            },\n            headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n        }).on('complete', function(data, response){\n            if(data.d && data.d.results){\n                cb(null, data.d.results[0]);\n            }\n            else {\n                cb(\"Error retrieving item\", data);\n            }\n        });\n    },\n    getItems: function(groupID, cb){\n        exact.get('/api/v1/'+division+'/logistics/Items', {\n            query: {\n                access_token: access_token,\n                $select: \"ID, Code, ItemGroupDescription, Description, ItemGroup\",\n                $filter: groupID? \"ItemGroup eq guid'\"+groupID+\"'\" : undefined,\n            },\n            headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n        }).on('complete', function(data, response){\n            if(data.d && data.d.results){\n                cb(null, data.d.results);\n            }\n            else if(cb) {\n                cb(\"Error retrieving items\", data);\n            }\n        });\n    },\n    getItemGroups: function(cb){\n        exact.get('api/v1/' + division + '/logistics/ItemGroups', {\n            query: {\n                access_token: access_token,\n                $select: 'ID,Description',\n            },\n            headers: { 'Accept': 'application/json', 'User-Agent': 'Restler for node.js' },\n        }).on('complete', function(data, response){\n            var groups = [];\n            if(!data){\n                console.log(response);\n                cb(\"Some error from Exact\", null);\n                return;\n            }\n            data.d.results.forEach(function(result){\n                groups.push({\n                    id: result.ID,\n                    description: result.Description\n                });\n            });\n            cb(null, groups);\n        });\n    },\n    copyBOM: function(source_id, dest_items, cookies, cb) {\n        //Get the BOM of the source\n        exact.getBOM(source_id, function(err, data){\n            if(err) return cb(err, data);\n            //Construct a builder object\n            var builder = new BOMBuilder(data);\n            var cookie_holder = new CookieHolder(cookies);\n            //For each destination item\n            var updates = [];\n            var cb_called = false;\n            var i = 0;\n            (function iterator(){\n                var item = dest_items[i];\n                exact.getBOMID(item.id, function(err, id){\n                    if(err) {\n                        console.warn(\"Error getting BOM ID: %j\", err);\n                        next();\n                    }\n                    else {\n                        exact.delete(id, cookie_holder, function(err, data, response){\n                            if(err) console.err(\"Error deleting: \"+err);\n                            else {\n                                var ok = cookie_holder.update_cookies(response);\n                                updates.push({\n                                    key: \"delete\",\n                                    message: ok? \"success\" : \"failed\"\n                                });\n                            }\n                            next();\n                        });\n                    }\n                    function next(){\n                        builder.set_item(item);\n                        var xml = builder.get_xml();\n                        exact.postBOM(xml).on('complete', function(data,response){\n                            if(response.statusCode > 200){\n                                console.warn(\"BOM post status code: \"+response.statusCode);\n                                updates.push({\n                                    key: response.statusCode,\n                                    msg: \"Error occurred\"\n                                });\n                            }\n                            else {\n                                data.eExact.Messages[0].Message.forEach(function(elem){\n                                    var key = elem.Topic[0].Data[0].$.keyAlt;\n                                    var msg = elem.Description[0];\n                                    updates.push({\n                                        key: key,\n                                        message: msg\n                                    });\n                                });\n                            }\n                            i++;\n                            if(i < dest_items.length){\n                                setTimeout(iterator, 2000);\n                            }\n                            else if (!cb_called) {\n                                cb(null, updates);\n                                cb_called = true;\n                            }\n                            else {\n                                console.warn(\"callback overcall!\");\n                            };\n                        });\n                    }\n                });\n            })();\n        });\n    },\n    getBOM: function(source_ID, cb){\n        exact.get(exact_get_url,{\n            query: {\n                access_token: access_token,\n                Params_Item: '{'+source_ID+'}',\n                _Division_: division,\n                Topic: 'ManufacturedBillOfMaterials' },\n            parser: rest.parsers.xml\n        }).on('complete', function(data, res){\n            if(!data.eExact.ManufacturedBillofMaterials){\n                console.warn(\"No BOM for \"+source_ID);\n                console.log(data);\n                return cb(null, null);\n            }\n            cb(null, data.eExact.ManufacturedBillofMaterials[0].ManufacturedBillofMaterial[0]);\n        });\n    },\n    getBOMID: function(item_ID, cb){\n        exact.getBOM(item_ID, function(err, data){\n            if(err) return cb(err, data);\n            var id = data.eExact.ManufacturedBillofMaterials[0].ManufacturedBillofMaterial[0].$.ID;\n            cb(null, id);\n        });\n    },\n    postBOM: function(xml){\n        return exact.post(exact_post_url, {\n            query: { access_token: access_token,\n                Topic: 'ManufacturedBillOfMaterials' },\n            parser: rest.parsers.xml,\n            data: xml\n        });\n    },\n    delete: function(id, cookie_holder, cb){\n        exact.get('/docs/LogItemVersion.aspx', {\n            query: {\n                ID: id,\n                BCAction: 3,\n                CSRFToken: cookie_holder.get_csrf(),\n                _Division_: division\n\n            },\n            headers: {\n                Cookie: cookie_holder.get_cookies()\n            },\n            timeout: 5000\n        }).on('complete', function(data, response){\n            cb(null, data, response);\n        }).on('timeout', function(){\n            console.error(\"Timeout!! retrying...\");\n            setTimeout(function(){\n                exact.delete(id, cookie_holder, cb);\n            }, 1000);\n        }).on('error', function(){\n            console.error('error!');\n        });\n    }\n});\n\nfunction cookieFormat(cookies){\n    var res = \"\";\n    for(var key in cookies){\n        if(cookies.hasOwnProperty(key)){\n            res+=key+\"=\"+cookies[key]+\";\";\n        }\n    }\n    return res;\n}\n\nvar CookieHolder = function(cookies){\n    var self = this;\n    this.cookies = cookies;\n    this.get_cookies = function(){\n        var res = \"\";\n        for(var key in self.cookies){\n            if(self.cookies.hasOwnProperty(key)){\n                res+=key+\"=\"+self.cookies[key]+\";\";\n            }\n        }\n        return res;\n    }\n    this.update_cookies = function(response){\n        var cookies = cookie_parser.parse(response);\n        if(cookies.length == 0){\n            console.err('No cookies found!');\n        }\n        else {\n            var ack = false;\n            cookies.forEach(function(cookie){\n                console.log(\"Cookie: \"+cookie.name);\n               self.cookies[cookie.name] = cookie.value;\n                if(cookie.name == \"PERSIST-EXACT\"){\n                    ack = true;\n                }\n            });\n        }\n        return ack;\n    }\n    this.get_csrf = function(){\n        return self.cookies.CSRFToken;\n    }\n\n}\n\nvar BOMBuilder = function(data){\n    var self = this;\n    this.data = data;\n    this.boms = this.data.eExact.ManufacturedBillofMaterials[0].ManufacturedBillofMaterial;\n    this.base_bom = this.boms[0];\n    this.builder = new xml2js.Builder();\n    this.set_item = function(item){\n        var props = self.base_bom.Item[0];\n        props.$.ID = item.id;\n        props.$.code = item.code;\n        props.Description[0] = item.description;\n    };\n    this.get_xml = function(){\n        return self.builder.buildObject(this.data);\n    };\n\n\n    //Unused\n    this.add = function(bom){\n        self.boms.push(bom);\n    }\n    this.add_copy = function(item){\n        var new_bom = clone(self.base_bom);\n        var props = new_bom.Item[0];\n        props.$.ID = item.id;\n        props.$.code = item.code;\n        props.Description[0] = item.description;\n        self.add(new_bom);\n    }\n};"]}